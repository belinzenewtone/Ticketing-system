generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// -----------------------------------------------------------------------------
// NEXTAUTH.JS ESSENTIALS
// -----------------------------------------------------------------------------

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// -----------------------------------------------------------------------------
// USER & PROFILE
// -----------------------------------------------------------------------------

enum UserRole {
  ADMIN
  IT_STAFF
  USER
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts        Account[]
  sessions        Session[]
  ticketsCreated  Ticket[]          @relation("TicketCreatedBy")
  ticketsAssigned Ticket[]          @relation("TicketAssignedTo")
  entries         Entry[]
  tasks           Task[]
  machineRequests MachineRequest[]
  cannedResponses CannedResponse[]
  kbArticles      KbArticle[]
  ticketComments  TicketComment[]
  ticketActivity  TicketActivity[]
}

// -----------------------------------------------------------------------------
// TICKETING SYSTEM ENUMS AND MODELS
// -----------------------------------------------------------------------------

enum ResolutionType {
  sorted
  alt_email @map("alt-email")
  alt_phone @map("alt-phone")
  alt_both  @map("alt-both")
  never_used @map("never-used")
  licensing
}

enum ImportanceLevel {
  urgent
  important
  neutral
}

enum MachineReason {
  old_hardware @map("old-hardware")
  faulty
  new_user     @map("new-user")
}

enum MachineStatus {
  pending
  approved
  fulfilled
  rejected
}

enum TicketCategory {
  email
  account_login   @map("account-login")
  password_reset  @map("password-reset")
  hardware
  software
  network_vpn     @map("network-vpn")
  other
}

enum TicketPriority {
  critical
  high
  medium
  low
}

enum TicketStatus {
  open
  in_progress @map("in-progress")
  resolved
  closed
}

enum TicketSentiment {
  positive
  neutral
  frustrated
  angry
}

model Entry {
  id               String         @id @default(cuid())
  number           Int            @default(autoincrement())
  entryDate        DateTime?      @map("entry_date") @db.Date
  employeeName     String         @map("employee_name")
  workEmail        String         @map("work_email")
  employeePhone    String?        @map("employee_phone")
  altEmailStatus   String?        @map("alt_email_status")
  altEmail         String?        @map("alt_email")
  resolution       ResolutionType
  completed        Boolean        @default(false)
  createdById      String?        @map("created_by")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  createdBy        User?          @relation(fields: [createdById], references: [id])

  @@map("entries")
}

model Task {
  id          String          @id @default(cuid())
  date        DateTime?       @db.Date
  text        String
  importance  ImportanceLevel
  completed   Boolean         @default(false)
  createdById String?         @map("created_by")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  createdBy   User?           @relation(fields: [createdById], references: [id])

  @@map("tasks")
}

model MachineRequest {
  id             String          @id @default(cuid())
  number         Int             @default(autoincrement())
  date           DateTime?       @db.Date
  requesterName  String          @map("requester_name")
  userName       String          @map("user_name")
  workEmail      String          @map("work_email")
  reason         MachineReason
  importance     ImportanceLevel
  status         MachineStatus   @default(pending)
  notes          String?         @db.Text
  createdById    String?         @map("created_by")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  createdBy      User?           @relation(fields: [createdById], references: [id])

  @@map("machine_requests")
}

model Ticket {
  id               String          @id @default(cuid())
  number           Int             @default(autoincrement())
  ticketDate       DateTime?       @map("ticket_date") @db.Date
  employeeName     String          @map("employee_name")
  department       String?
  category         TicketCategory
  priority         TicketPriority
  status           TicketStatus    @default(open)
  sentiment        TicketSentiment @default(neutral)
  subject          String
  description      String?         @db.Text
  resolutionNotes  String?         @map("resolution_notes") @db.Text
  internalNotes    String?         @map("internal_notes") @db.Text
  dueDate          DateTime?       @map("due_date")
  createdById      String?         @map("created_by")
  assignedToId     String?         @map("assigned_to")
  attachmentUrl    String?         @map("attachment_url")
  mergedIntoId     String?         @map("merged_into")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  createdBy        User?           @relation("TicketCreatedBy", fields: [createdById], references: [id])
  assignedTo       User?           @relation("TicketAssignedTo", fields: [assignedToId], references: [id])
  
  // Self-relation for merged tickets
  mergedInto       Ticket?         @relation("MergedTickets", fields: [mergedIntoId], references: [id])
  mergedTickets    Ticket[]        @relation("MergedTickets")

  comments         TicketComment[]
  activity         TicketActivity[]

  @@map("tickets")
}

model CannedResponse {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  createdById String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  createdBy   User?    @relation(fields: [createdById], references: [id])

  @@map("canned_responses")
}

model TicketActivity {
  id          String   @id @default(cuid())
  ticketId    String   @map("ticket_id")
  userId      String?  @map("user_id")
  action      String
  // JSON field in Postgres, mapped mapped to Json in Prisma
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id])

  @@map("ticket_activity")
}

model KbArticle {
  id          String          @id @default(cuid())
  title       String
  content     String          @db.Text
  category    TicketCategory?
  createdById String?         @map("created_by")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  createdBy   User?           @relation(fields: [createdById], references: [id])

  @@map("kb_articles")
}

model TicketComment {
  id          String   @id @default(cuid())
  ticketId    String   @map("ticket_id")
  userId      String?  @map("user_id")
  authorName  String   @map("author_name")
  content     String   @db.Text
  isInternal  Boolean  @default(false) @map("is_internal")
  createdAt   DateTime @default(now()) @map("created_at")

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id])

  @@map("ticket_comments")
}
